# DOORKEEPER架构与工作流程

## 系统架构

DoorKeeper的架构图如下所示：

             |                                  |
          Internet                          Internet
		     |                                  |
             |                  +-------------------<<-----
             |                  |               |
             |       +----------|-----------+   |
             |       | DKS    +-+-+         |   |
    +---+    |       |        | C |   +---+ |   |
    | 1 +--------+   |        +---+   | A +---------<<-----
    +---+    |   |   |                +---+ |   |
             |   |   | +---+                |   |
             |   +-----+ 0 |                |   |
             |   |   | +---+                |   |
    +---+    |   |   |                +---+ |   |
    | 2 +--------+   |                | B +---------<<-----
    +---+    |       |                +---+ |   |
             |       |                      |   |
             |       +----------------------+   |
             |                                  |

### 客户端（后端）

最左侧的`1`和`2`表示运行DK客户端模式的主机。它们通过NAT路由器访问互联网，外部是不能直接访问的。DK客户端启动后，自动连接位于公网的`DKS`（DK服务端），建立TCP长连接。

### 服务端（控制端/前端）

中间的`DKS`方框表示运行DK服务端模式的主机。它提供从公网访问处于内网中的后端主机的通道。

图中的`0`表示一个TCP连接端口，称为`serv_port`，所有后端均连接该端口。`C`表示用于权限控制的HTTP端口。`A`和`B`表示客户端





/*
const (
	CT_CLS = 0    //关闭连接
	CT_DAT = 1    //数据传输
	CT_QRY = 2    //询问开放端口
	CT_PNG = 3    //通道心跳检测
	MTU    = 4000 //传输块长度必须小于4096，因为包头表示长度用了12bit
)
# CHUNK结构


*/
/*
一、新建连接
1. 远端连接到一个服务端口
2. 检查该远端IP的授权记录，如果没有查到，直接关闭连接
3. 查到该远端IP的目标后端后，发起连接请求，数据结构如下：
   

二、现有连接的维持

*/