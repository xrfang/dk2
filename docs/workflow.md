# DOORKEEPER架构与工作流程

## 系统架构

DoorKeeper的架构图如下所示：

             |                                  |
          Internet                          Internet
		     |                                  |
             |                  +-------------------<<-----
             |                  |               |
             |       +----------|-----------+   |
             |       | DKG    +-+-+         |   |
    +---+    |       |        | C |   +---+ |   |
    | 1 +--------+   |        +---+   | A +---------<<-----
    +---+    |   |   |                +---+ |   |
             |   |   | +---+                |   |
             |   +-----+ 0 |                |   |
             |   |   | +---+                |   |
    +---+    |   |   |                +---+ |   |
    | 2 +--------+   |                | B +---------<<-----
    +---+    |       |                +---+ |   |
             |       |                      |   |
             |       +----------------------+   |
             |                                  |

### 后端（backend）

最左侧的`1`和`2`表示运行DK后端模式（简称`DKS`）的主机。它们通过NAT路由器访问互联网，外部是不能直接访问的。`DKS`启动后，自动连接位于公网的DK控制端（简称`DKG`），建立TCP长连接。

### 控制端（gateway）

中间的`DKG`方框表示运行DK控制端模式的主机。它提供从公网访问处于内网中的`DKS`主机的通道。图中的`0`表示一个TCP连接端口（`serv_port`），所有后端均连接该端口。`C`表示用于权限控制的HTTP端口（`mgmt_port`）。`A`和`B`表示客户端接入端口。根据需要，`DKG`会动态开启接入端（端口号从`serv_port+1`开始依次增长），也会关闭闲置的接入端。

### 用户端

用户端（简称`CLI`）是指通过`DKG`访问`DKS`的计算机系统，对于DK系统而言，是外部客户。

## 交互流程

DK系统的外部交互流程为：

1. `CLI`通过`C`端口向DK系统申请开通连接某个后端的通道
1. `DKG`对`CLI`进行鉴权，如果没有权限，直接断开连接，流程结束；否则，
1. `DKG`检查是否有一个空闲的接入端可供该客户使用的，如果有，则直接使用，否则，为其开启一个新的接入端
1. `CLI`通过TCP协议访问`DKG`提供的接入端口（注意：DK系统只支持TCP，不支持UDP或其它协议）

## 核心数据结构

### 后端鉴权

后端连接到`DKG`的`serv_port`后，应在`gateway.handshake`所定义的时间（默认为10秒）内发送握手报文。定义如下：

- 总长度为32字节
- 其中前16字节内容为随机数，记作`seed`，由客户端生成
- 后16字节的内容是`HMAC-SHA256(<seed>+<name>, <key>)`的前16个字节
- 上述计算中的`name`和`key`是`DKG`和`DKS`约定的用户名/密码对。

如果`DKG`确认握手报文没有问题，该后端即连接成功。

### 通信协议

DK基于TCP进行通信，数据包格式为：

* 0～1子节：分为**类型**和**包长度**两部分。以下描述中，bit-0表示字节0的最高位，bit-15表示字节1的最低位：
  - 0～2：数据包类型。目前定义了4种包类型，bit-2未用，保持为0。
  - 3～15：数据包长度（含头，大端序）。DK通信包的最大长度为8192字节。
* 2～5字节：SESSION-ID（由`DKG`分配的随机数）。
* 6～字节：各类型包定义。

<u>**数据包类型及其格式定义**</u>

> 包类型为第0个字节的最高两bit。

* **ChunkCLS（关闭连接，00）**：包体内容为需要关闭的SESSION-ID（4字节）。
* **ChunkOPN（建立连接，01）**：包体内容的前4字节为SESSION-ID，后续为需要连接的后端端口（大端序uint16）和IP地址（可以是IPv4或IPv6）。
* **ChunkDAT（数据传输，10）**：包体内容的前4字节为SESSION-ID，后续为所需传输的数据。
* **ChunkCMD（系统命令，11）**：包体内容的第1字节为命令，后续为命令参数。目前定义的命令有：
   * **0**：PING包，保持后端连接不因为无通信而被NAT防火墙关闭。该命令无参数。
   * **1**：端口查询，参数为所需查询的端口号（大端序uint16）。后端收到该指令回复局域网内所有打开指定端口的主机的IP清单。

## API

`DKG`通过
/*
一、新建连接
1. 远端连接到一个服务端口
2. 检查该远端IP的授权记录，如果没有查到，直接关闭连接
3. 查到该远端IP的目标后端后，发起连接请求，数据结构如下：
   

二、现有连接的维持

*/